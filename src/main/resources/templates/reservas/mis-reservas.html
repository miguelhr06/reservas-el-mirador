<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Mis Reservas - El Mirador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        body {
            min-height: 100vh;
            background:
                linear-gradient(rgba(20, 40, 20, 0.85), rgba(20, 40, 20, 0.9)),
                url('/img/bg-campestre.jpg') center/cover fixed no-repeat;
            font-family: "Segoe UI", system-ui;
        }

        /* NAVBAR */
        .navbar-mirador {
            background: linear-gradient(90deg, #1b5e20, #43a047);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* CARD GENERAL */
        .card-campestre {
            border-radius: 20px;
            overflow: hidden;
            border: none;
            background: rgba(255,255,255,0.97);
            box-shadow: 0 10px 35px rgba(0,0,0,0.40);
        }

        .table thead {
            background: #e9f4e5;
        }

        .badge {
            border-radius: 999px;
            padding: 0.45rem 0.8rem;
            font-weight: 600;
        }

        .btn-custom {
            border-radius: 999px !important;
            padding-inline: 14px !important;
        }

        h2 {
            color: white;
            text-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }

        .alert-success {
            border-radius: 12px;
        }

        .no-reservas-card {
            background: rgba(255,255,255,0.95);
            border-radius: 18px;
            padding: 3rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark navbar-mirador mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">El Mirador</a>

        <div class="d-flex align-items-center">
            <a href="/reservas/buscar" class="btn btn-outline-light me-3 btn-sm btn-custom">
                <i class="bi bi-plus-circle"></i> Nueva Reserva
            </a>

            <form th:action="@{/logout}" method="post">
                <button class="btn btn-danger btn-sm btn-custom">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </form>
        </div>
    </div>
</nav>

<div class="container pb-5">

    <!-- TÍTULO + MENSAJES -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0">Mis Reservas</h2>

        <div>
            <div th:if="${param.exito}" class="alert alert-success py-1 px-3 m-0">
                <i class="bi bi-check-circle"></i> ¡Reserva creada con éxito!
            </div>

            <div th:if="${param.pagoExitoso}" class="alert alert-success py-1 px-3 m-0">
                <i class="bi bi-cash-coin"></i> ¡Pago registrado! Lo validaremos en breve.
            </div>
        </div>
    </div>

    <!-- TABLA -->
    <div class="card card-campestre">
        <div class="card-body p-0">

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Recurso</th>
                            <th>Fechas</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>

                    <tbody>

                    <!-- LISTA DE RESERVAS -->
                    <tr th:each="reserva : ${reservas}">
                        <!-- CÓDIGO -->
                        <td>
                            <strong th:text="${reserva.codigoReserva}">RES-001</strong>
                            <br>
                            <small class="text-muted" th:text="${#temporals.format(reserva.createdAt, 'dd/MM/yyyy')}">Fecha</small>
                        </td>

                        <!-- RECURSO -->
                        <td>
                            <span th:text="${reserva.recurso.nombre}">Bungalow</span><br>
                            <small class="text-muted">
                                <i class="bi bi-people"></i>
                                <span th:text="${reserva.cantidadPersonas}">2</span> pers.
                            </small>
                        </td>

                        <!-- FECHAS -->
                        <td>
                            <div class="d-flex flex-column">
                                <small>Del: <span th:text="${#temporals.format(reserva.fechaInicio, 'dd/MM HH:mm')}"></span></small>
                                <small>Al:  <span th:text="${#temporals.format(reserva.fechaFin, 'dd/MM HH:mm')}"></span></small>
                            </div>
                        </td>

                        <!-- TOTAL -->
                        <td class="fw-bold">
                            S/ <span th:text="${reserva.precioTotal}"></span>
                        </td>

                        <!-- ESTADO -->
                        <td>
                            <span th:if="${reserva.estado.name() == 'PENDIENTE_PAGO'}" class="badge bg-warning text-dark">Pendiente Pago</span>
                            <span th:if="${reserva.estado.name() == 'ESPERANDO_CONFIRMACION'}" class="badge bg-info text-white">Validando Pago</span>
                            <span th:if="${reserva.estado.name() == 'CONFIRMADA'}" class="badge bg-success">Confirmada</span>
                            <span th:if="${reserva.estado.name() == 'CANCELADA'}" class="badge bg-danger">Cancelada</span>
                            <span th:if="${reserva.estado.name() == 'COMPLETADA'}" class="badge bg-secondary">Finalizada</span>
                        </td>

                        <!-- ACCIONES -->
                        <td class="text-center">

                            <!-- PAGAR -->
                            <a th:if="${reserva.estado.name() == 'PENDIENTE_PAGO'}"
                               th:href="@{/pagos/registrar/{id}(id=${reserva.idReserva})}"
                               class="btn btn-success btn-sm btn-custom me-1" title="Pagar ahora">
                                <i class="bi bi-credit-card"></i>
                            </a>

                            <!-- VER DETALLE -->
                            <a th:href="@{/reservas/detalle/{id}(id=${reserva.idReserva})}"
                               class="btn btn-outline-secondary btn-sm btn-custom me-1">
                                <i class="bi bi-eye"></i>
                            </a>

                            <!-- CANCELAR -->
                            <a th:if="${reserva.estado.name() == 'PENDIENTE_PAGO'}"
                               th:href="@{/reservas/cancelar/{id}(id=${reserva.idReserva})}"
                               class="btn btn-danger btn-sm btn-custom"
                               onclick="return confirm('¿Estás seguro de cancelar esta reserva?');">
                                <i class="bi bi-x-lg"></i>
                            </a>

                            <!-- ESPERANDO CONFIRMACIÓN -->
                            <small th:if="${reserva.estado.name() == 'ESPERANDO_CONFIRMACION'}"
                                   class="text-muted fst-italic d-block mt-1">
                                Validando pago...
                            </small>

                        </td>
                    </tr>

                    <!-- SIN RESERVAS -->
                    <tr th:if="${reservas.isEmpty()}">
                        <td colspan="6" class="py-5">
                            <div class="no-reservas-card mx-auto text-center" style="max-width: 500px;">
                                <h4 class="text-muted mb-3">Aún no tienes reservas</h4>
                                <p class="text-muted">Explora nuestros bungalows y vive la experiencia El Mirador.</p>
                                <a href="/reservas/buscar" class="btn btn-success btn-custom mt-2">
                                    Hacer mi primera reserva
                                </a>
                            </div>
                        </td>
                    </tr>

                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

</body>
</html>
